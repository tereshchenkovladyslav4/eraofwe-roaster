<section>
    <!--Chat Main screen with accounts-->
    <div
        class="chat mt-chat"
        data-element="chat"
        [ngClass]="{
            open: (chatService.isOpen | async),
            'expand-active': (chatService.isOpen | async) && openedThread && (chatService.isExpand | async)
        }"
    >
        <ng-container
            *ngIf="chatService.isOpen"
            appLifecyclehook
            (viewChecked)="chatVisibilityRendered.next(chatService.isOpen.value)"
        ></ng-container>
        <!--Remove expand mode-->
        <div class="chat-head" data-element="chat-head">
            <button class="back-to-shrinkMode" (click)="closeExapndView()">
                <img src="assets/images/dm-back-arrow.svg" />
            </button>
        </div>

        <!--Chat body-->
        <div class="chat-body">
            <!--Expand Mode div-->
            <div class="chat-body__expand" data-element="chat-body-expand">
                <ng-container
                    appLifecyclehook
                    (viewChecked)="chatBoxpanelRendered.next('EXPAND')"
                    *ngIf="chatService.isExpand | async"
                >
                    <div class="live-caht__head clearfix" data-element="live-chat-head">
                        <div class="live-account-profile">
                            <button class="back-to-accounts" (click)="backToAccountListing()">
                                <img src="assets/images/dm-back-arrow.svg" />
                            </button>
                            <div class="d-inline-block profile-pic pointer" (click)="openUserInfoPanel(openedThread)">
                                <span
                                    class="profile-pic__item bg-profile"
                                    [style.backgroundImage]="openedThread?.computed_targetedUser.computed_profile_dp"
                                ></span>
                                <span *ngIf="openedThread?.computed_targetedUser.online" class="live-account"></span>
                                <span
                                    *ngIf="!openedThread?.computed_targetedUser.online"
                                    class="offline-account"
                                ></span>
                            </div>
                            <div class="chat-profile clearfix pointer" (click)="openUserInfoPanel(openedThread)">
                                <div class="chat-profile__name d-inline-block">
                                    <h5 class="name">
                                        {{ openedThread?.computed_targetedUser.computed_fullname }}
                                    </h5>
                                    <span class="status">
                                        {{ openedThread?.computed_targetedUser.computed_organization_name }}
                                    </span>
                                    <span>&nbsp;</span>
                                    <span
                                        *ngIf="
                                            !openedThread?.computed_targetedUser.online &&
                                            openedThread?.computed_targetedUser?.computed_lastseen
                                        "
                                        class="status last-seen"
                                    >
                                        Last Seen at
                                        {{ openedThread?.computed_targetedUser?.computed_lastseen }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="chat-seeting position-relative" *ngIf="openedThread">
                            <a class="menu-arrow">
                                <p><img class="ellipse-image" src="assets/images/three-dots.svg" alt="" /></p>
                            </a>

                            <div class="chat-seeting__items">
                                <ul class="list-group custom-popover chat-seeting__content">
                                    <li
                                        *ngIf="!openedThread.computed_mute"
                                        class="list-group-item"
                                        (click)="openedThread.computed_mute = true"
                                    >
                                        <a class="pointer-item">Mute </a>
                                    </li>
                                    <li
                                        *ngIf="openedThread.computed_mute"
                                        class="list-group-item"
                                        (click)="openedThread.computed_mute = false"
                                    >
                                        <a class="pointer-item">Unmute </a>
                                    </li>

                                    <li class="list-group-item list-group-item__disabled">
                                        <a class="pointer-item">{{ globals.languageJson?.mark_unread }}</a>
                                    </li>
                                    <li class="list-group-item list-group-item__disabled">
                                        <a class="pointer-item">{{ globals.languageJson?.archive }}</a>
                                    </li>
                                    <li class="list-group-item list-group-item__disabled">
                                        <a class="pointer-item">{{ globals.languageJson?.report }}</a>
                                    </li>
                                    <li class="list-group-item list-group-item__disabled">
                                        <a class="pointer-item">{{ globals.languageJson?.delete_conversation }}</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!--Live Chats are going here-->
                    <div class="live-chat-message-body position-relative" data-element="live-chat-message-body">
                        <div *ngFor="let message of messageList; let last = last" [attr.data-chat-id]="message.id">
                            <div appLifecyclehook (viewChecked)="last && lastMessageRendered.next('done')">
                                <div class="message-to live-chat-message-body__text" *ngIf="message.isActiveUser">
                                    <p class="live-time">{{ message.computed_date }}</p>
                                    <div class="message-body">
                                        <div class="message-to__text">
                                            <span>{{ message.content }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="message-from live-chat-message-body__text" *ngIf="!message.isActiveUser">
                                    <p class="live-time-from">{{ message.computed_date }}</p>
                                    <div class="message-body-from">
                                        <div class="message-to__from">
                                            <span>{{ message.content }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div data-element="message-form">
                        <div class="messag-form position-relative">
                            <div class="offensive-lang" [ngClass]="{ active: showOffensiveMessageError }">
                                <span
                                    >Use of offensive language is strictly prohibited using within member to member
                                    messaging, on our public groups, non-compliance may lead to permanent / temporary
                                    suspension of your account.</span
                                >
                            </div>
                            <div class="img-container">
                                <span class="img-container__remove">&#10008;</span>
                            </div>

                            <div class="chat-inputs">
                                <label class="chat-inputs__img">
                                    <img src="assets/images/dm-img-upload.svg" />
                                    <input type="file" class="files" />
                                </label>
                                <textarea
                                    (keypress)="inputkeyPress($event)"
                                    (input)="inputChanges($event)"
                                    data-element="messag-text-area"
                                    type="text"
                                    rows="1"
                                    class="chat-inputs__text"
                                    placeholder="Type something.."
                                    [(ngModel)]="messageInput"
                                ></textarea>
                                <div class="send-message">
                                    <button (click)="sendMessage()" type="button" class="send-message__btn">
                                        <img src="assets/images/dm-send2.svg" />
                                    </button>
                                </div>
                            </div>
                            <div class="send-message">
                                <button (click)="sendMessage()" type="button" class="send-message__btn">
                                    <span>send</span>
                                    <img src="assets/images/dm-send.svg" />
                                </button>
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>

            <!--Chat box witn live chat and account sections-->
            <div class="chat-box clearfix" data-element="chat-box">
                <div class="chat-accounts position-relative">
                    <div data-element="chat-account-head" class="chat-accounts__head clearfix">
                        <h4 class="chat-title">{{ globals.languageJson?.messaging }}</h4>

                        <!--Chat control-->
                        <div class="chat-control">
                            <div class="chat-control__expand d-block" (click)="toggleExpandView()">
                                <img *ngIf="!(chatService.isExpand | async)" src="assets/images/dm-expand.svg" />
                                <img *ngIf="chatService.isExpand | async" src="assets/images/dm-collapse.svg" />
                            </div>
                            <div class="chat-control__close" (click)="closePanel()">
                                <img src="assets/images/dm-chat-close.svg" />
                            </div>
                        </div>
                    </div>

                    <!---Live chats at particular account-->
                    <!-- <ng-template #liveChatRef> -->
                    <div
                        data-element="live-chat"
                        class="live-chat collapse-chat"
                        [ngClass]="{ active: openedThread && !(chatService.isExpand | async) }"
                    >
                        <ng-container
                            appLifecyclehook
                            (viewChecked)="chatBoxpanelRendered.next('COLLAPSE')"
                            *ngIf="!(chatService.isExpand | async)"
                        >
                            <div class="live-caht__head clearfix" data-element="live-chat-head">
                                <div class="live-account-profile">
                                    <button class="back-to-accounts" (click)="backToAccountListing()">
                                        <img src="assets/images/dm-back-arrow.svg" />
                                    </button>
                                    <div
                                        class="d-inline-block profile-pic pointer"
                                        (click)="openUserInfoPanel(openedThread)"
                                    >
                                        <span
                                            class="profile-pic__item bg-profile"
                                            [style.backgroundImage]="
                                                openedThread?.computed_targetedUser.computed_profile_dp
                                            "
                                        ></span>
                                        <span
                                            *ngIf="openedThread?.computed_targetedUser.online"
                                            class="live-account"
                                        ></span>
                                        <span
                                            *ngIf="!openedThread?.computed_targetedUser.online"
                                            class="offline-account"
                                        ></span>
                                    </div>
                                    <div
                                        class="chat-profile clearfix pointer"
                                        (click)="openUserInfoPanel(openedThread)"
                                    >
                                        <div class="chat-profile__name d-inline-block">
                                            <h5 class="name">
                                                {{ openedThread?.computed_targetedUser.computed_fullname }}
                                            </h5>
                                            <span class="status">{{
                                                openedThread?.computed_targetedUser.computed_organization_name
                                            }}</span>
                                            <span>&nbsp;</span>
                                            <span
                                                *ngIf="
                                                    !openedThread?.computed_targetedUser.online &&
                                                    openedThread?.computed_targetedUser?.computed_lastseen
                                                "
                                                class="status last-seen"
                                                >Last Seen at
                                                {{ openedThread?.computed_targetedUser?.computed_lastseen || '' }}
                                            </span>
                                        </div>
                                    </div>

                                    <div class="chat-seeting position-relative" *ngIf="openedThread">
                                        <a class="menu-arrow">
                                            <p>
                                                <img class="ellipse-image" src="assets/images/three-dots.svg" alt="" />
                                            </p>
                                        </a>

                                        <div class="chat-seeting__items">
                                            <ul class="list-group custom-popover chat-seeting__content">
                                                <li
                                                    *ngIf="!openedThread.computed_mute"
                                                    class="list-group-item"
                                                    (click)="openedThread.computed_mute = true"
                                                >
                                                    <a class="pointer-item">Mute </a>
                                                </li>
                                                <li
                                                    *ngIf="openedThread.computed_mute"
                                                    class="list-group-item"
                                                    (click)="openedThread.computed_mute = false"
                                                >
                                                    <a class="pointer-item">Unmute </a>
                                                </li>

                                                <li class="list-group-item list-group-item__disabled">
                                                    <a class="pointer-item">{{ globals.languageJson?.mark_unread }}</a>
                                                </li>
                                                <li class="list-group-item list-group-item__disabled">
                                                    <a class="pointer-item">{{ globals.languageJson?.archive }}</a>
                                                </li>
                                                <li class="list-group-item list-group-item__disabled">
                                                    <a class="pointer-item">{{ globals.languageJson?.report }}</a>
                                                </li>
                                                <li class="list-group-item list-group-item__disabled">
                                                    <a class="pointer-item">{{
                                                        globals.languageJson?.delete_conversation
                                                    }}</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!--Live Chats are going here-->
                            <div class="live-chat-message-body position-relative" data-element="live-chat-message-body">
                                <div
                                    *ngFor="let message of messageList; let last = last"
                                    [attr.data-chat-id]="message.id"
                                >
                                    <div appLifecyclehook (viewChecked)="last && lastMessageRendered.next('done')">
                                        <div
                                            class="message-to live-chat-message-body__text"
                                            *ngIf="message.isActiveUser"
                                        >
                                            <p class="live-time">{{ message.computed_date }}</p>
                                            <div class="message-body">
                                                <div class="message-to__text">
                                                    <span>{{ message.content }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            class="message-from live-chat-message-body__text"
                                            *ngIf="!message.isActiveUser"
                                        >
                                            <p class="live-time-from">{{ message.computed_date }}</p>
                                            <div class="message-body-from">
                                                <div class="message-to__from">
                                                    <span>{{ message.content }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!--Send Message div-->
                            <div data-element="message-form">
                                <div class="messag-form position-relative">
                                    <div class="offensive-lang" [ngClass]="{ active: showOffensiveMessageError }">
                                        <span
                                            >Use of offensive language is strictly prohibited using within member to
                                            member messaging, on our public groups, non-compliance may lead to permanent
                                            / temporary suspension of your account.</span
                                        >
                                    </div>
                                    <div class="img-container">
                                        <span class="img-container__remove">&#10008;</span>
                                    </div>

                                    <div class="chat-inputs">
                                        <label class="chat-inputs__img">
                                            <img src="assets/images/dm-img-upload.svg" />
                                            <input type="file" class="files" />
                                        </label>
                                        <textarea
                                            (keypress)="inputkeyPress($event)"
                                            (input)="inputChanges($event)"
                                            data-element="messag-text-area"
                                            type="text"
                                            rows="1"
                                            class="chat-inputs__text"
                                            placeholder="Type something.."
                                            [(ngModel)]="messageInput"
                                        ></textarea>
                                        <div class="send-message">
                                            <button (click)="sendMessage()" type="button" class="send-message__btn">
                                                <img src="assets/images/dm-send2.svg" />
                                            </button>
                                        </div>
                                    </div>
                                    <div class="send-message">
                                        <button (click)="sendMessage()" type="button" class="send-message__btn">
                                            <span>send</span>
                                            <img src="assets/images/dm-send.svg" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                    <!-- </ng-template> -->

                    <!-- <ng-template [ngTemplateOutlet]="liveChatRef"></ng-template> -->

                    <!--Account Setting-->

                    <div data-element="account-setting" class="account-setting" [ngClass]="{ open: selectedUser }">
                        <ng-container *ngIf="selectedUser">
                            <div class="account-setting__back">
                                <div class="back-to-conversation" (click)="closeUserInfoPanel()">
                                    <img src="assets/images/dm-back-arrow.svg" />
                                    <span>Back to Conversation list</span>
                                </div>
                                <div class="account-setting__profile clearfix">
                                    <div class="set-profile">
                                        <span
                                            class="bg-user-dp"
                                            [style.backgroundImage]="selectedUser.computed_profile_dp"
                                        ></span>
                                    </div>
                                    <div class="set-profile-name">
                                        <h5 class="name">{{ selectedUser.computed_fullname }}</h5>
                                        <span class="status"> {{ selectedUser.computed_organization_name }}</span>
                                    </div>
                                </div>
                                <div class="account-setting-option">
                                    <!--Search in conversion-->
                                    <div class="account-setting-option__item">
                                        <a class="d-flex justify-content-between align-items-center" href="#"
                                            ><span class="fnt-16 fnt-muli fnt-600 text-clr334 d-inline-block">{{
                                                globals.languageJson?.serach_conversation
                                            }}</span
                                            ><img class="ml-auto" src="assets/images/setting-arrow.svg"
                                        /></a>
                                    </div>

                                    <!--Clear Conversion-->
                                    <div
                                        class="account-setting-option__item d-flex justify-content-between align-items-center"
                                    >
                                        <span class="fnt-16 fnt-muli fnt-600 text-clr334 d-inline-block">{{
                                            globals.languageJson?.notifications
                                        }}</span>
                                        <div class="notification-control ml-auto">
                                            <input type="radio" name="notification" value="off" />
                                            <input type="radio" name="notification" value="on" />
                                            <span class="switch-control"></span>
                                        </div>
                                    </div>

                                    <!--Clear Conversion-->
                                    <div class="account-setting-option__item">
                                        <a class="d-flex justify-content-between align-items-center" href="#"
                                            ><span class="fnt-16 fnt-muli fnt-600 text-clr334 d-inline-block">{{
                                                globals.languageJson?.clear_conversation
                                            }}</span
                                            ><img class="ml-auto" src="assets/images/setting-arrow.svg"
                                        /></a>
                                    </div>

                                    <!--Report User-->
                                    <div class="account-setting-option__item">
                                        <a class="d-flex justify-content-between align-items-center" href="#"
                                            ><span class="fnt-16 fnt-muli fnt-600 text-clr334 d-inline-block">{{
                                                globals.languageJson?.report_user
                                            }}</span
                                            ><img class="ml-auto" src="assets/images/setting-arrow.svg"
                                        /></a>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>

                    <!--All accounts body with search-->
                    <div
                        data-element="account-body"
                        class="chat-accounts__body"
                        [ngClass]="{ active: !openedThread || (chatService.isExpand | async) }"
                    >
                        <ng-container *ngIf="chatService.userSearch | async">
                            <div class="back-to-conversation" (click)="backToListFromUsers()">
                                <img src="assets/images/dm-back-arrow.svg" />
                                <span>Back to Conversation list</span>
                            </div>
                            <div class="search-account position-relative">
                                <img src="assets/images/dm-search.svg" />
                                <input
                                    [(ngModel)]="userSearchKeywords"
                                    class="search-account__input"
                                    type="search"
                                    data-element="user-search-input"
                                    placeholder="Search users"
                                    appLifecyclehook
                                    (viewChecked)="userSearchPanelRendered.next('done')"
                                />
                                <img
                                    *ngIf="userSearchKeywords"
                                    class="search-close-button"
                                    (click)="userSearchKeywords = ''"
                                    src="assets/images/dm-close.svg"
                                />
                            </div>

                            <div class="chat-accounts__name user-list-padding">
                                <!--User Search-->
                                <ng-container *ngIf="!userSearchKeywords">
                                    <span class="recent-tag">Recents</span>
                                    <div
                                        class="clearfix account"
                                        *ngFor="let user of recentUserList"
                                        (click)="openThreadWithUser(user)"
                                    >
                                        <div class="d-inline-block profile-pic">
                                            <span
                                                class="profile-pic__item bg-profile"
                                                [style.backgroundImage]="user.computed_profile_dp"
                                            ></span>
                                        </div>
                                        <div class="chat-profile clearfix">
                                            <div class="chat-profile__name d-inline-block">
                                                <h5 class="name">{{ user.computed_fullname }}</h5>
                                                <span class="status">{{ user.computed_organization_name }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </ng-container>
                                <ng-container *ngIf="userSearchKeywords">
                                    <div
                                        class="clearfix account"
                                        *ngFor="let user of usersList"
                                        (click)="openThreadWithUser(user)"
                                    >
                                        <div class="d-inline-block profile-pic">
                                            <span
                                                class="profile-pic__item bg-profile"
                                                [style.backgroundImage]="user.computed_profile_dp"
                                            ></span>
                                        </div>
                                        <div class="chat-profile clearfix">
                                            <div class="chat-profile__name d-inline-block">
                                                <h5 class="name">{{ user.computed_fullname }}</h5>
                                                <span class="status">{{ user.computed_organization_name }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </ng-container>

                        <ng-container *ngIf="!(chatService.userSearch | async)">
                            <div class="search-account position-relative">
                                <img src="assets/images/dm-search.svg" />
                                <input
                                    [(ngModel)]="threadSearchKeyword"
                                    class="search-account__input"
                                    type="search"
                                    placeholder="Search Messages"
                                />
                                <img
                                    *ngIf="threadSearchKeyword"
                                    class="search-close-button"
                                    (click)="threadSearchKeyword = ''"
                                    src="assets/images/dm-close.svg"
                                />
                            </div>

                            <div class="chat-accounts__name">
                                <!--Account-->
                                <div
                                    class="thread-block"
                                    [ngClass]="{ activate_account: openedThread && thread.id === openedThread.id }"
                                    *ngFor="let thread of threadList | searchFilter: threadSearchKeyword"
                                >
                                    <div class="clearfix account" (click)="openThreadChat(thread)">
                                        <div class="d-inline-block profile-pic">
                                            <span
                                                class="profile-pic__item bg-profile"
                                                [style.backgroundImage]="
                                                    thread.computed_targetedUser.computed_profile_dp
                                                "
                                            ></span>
                                            <span
                                                *ngIf="thread.computed_targetedUser.online"
                                                class="live-account"
                                            ></span>
                                            <span
                                                *ngIf="!thread.computed_targetedUser.online"
                                                class="offline-account"
                                            ></span>
                                        </div>
                                        <div class="chat-profile clearfix">
                                            <div class="chat-profile__name d-inline-block">
                                                <div class="chat-profile__time">
                                                    <span>{{ thread.computed_createdAt }}</span>
                                                </div>
                                                <h5 class="name">
                                                    {{ thread.computed_targetedUser.computed_fullname }}
                                                </h5>
                                                <span class="status">{{
                                                    thread.computed_targetedUser.computed_organization_name
                                                }}</span>
                                            </div>

                                            <div class="chat-messaged">
                                                <p class="chat-messaged__text">
                                                    {{ thread.computed_lastActivityText }}
                                                </p>
                                                <span
                                                    *ngIf="thread.unread && thread.unread > 0"
                                                    class="chat-messaged__total"
                                                    >{{ thread.unread }}</span
                                                >
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="start-chat">
                                <button (click)="startNewChat()" class="start-chat__btn">
                                    <span>Start chat</span>
                                </button>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
